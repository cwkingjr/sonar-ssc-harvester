# Read the blog entry about project sonar
https://community.rapid7.com/community/infosec/sonar/blog/2013/09/26/welcome-to-project-sonar

# where to grab the 15G of compressed cert data files
https://scans.io/study/sonar.ssl

# prepping your environment for python module install below 
sudo apt-get install python-pip
sudo pip install --upgrade setuptools

# built-in python module bz2 can not decode multi-stream files, which is
# how pbzip2 encodes them.  Project Sonar encoded the cert files with pbzip2,
# so we need to install the bz2file module from PyPI. 

# Read about the module
https://github.com/nvawda/bz2file

# Install the module
sudo pip install bz2file

# To support MaxMind GeoIP reading, I used this module:
https://github.com/appliedsec/pygeoip

# To install it
sudo pip install pygeoip

# About the cert files
Each pbzip2-compressed file contains the information about one host on one line, in JSON format (see example cert in z-example-sonar-cert-record-unzipped.txt).  Within the JSON string is an array of certificates, with the first being the host certificate, and others, when provided being certificates in the CA chain.  Within each certificate section, the certificate is Base64 encoded.  Inside the Base64 encoding, the certificate is x509 encoded.  Within the x509 encoding is information about the Issuer and Subject (among other things).  I used the Issuer.organizationName and Subject.organizationName data in a comparison and when these two records matched, am making the non-deterministic decision that the certificate is self-signed.  While the vast majority of records parse correctly, some number do not, and those are counted within the error numbers in the log file.  Also, when reviewing the output data, some limited number of records apprear to have either gibberish entries or certificate creation mistake entries.

# Note about self-signed certs
It is VERY common for large organizations to manage their own Certificate Authority, issue all their own certs, etc.  An example of this is the US Government (.mil, .gov, etc), Google, various large ISPs, etc.  These large issuers actually do have processes that include root certs, signing certs, and individually signed CSRs, CRL/OCSP management, etc.  These cases should be considered differently tha one-off self-signed certificate that gets generated by an individual or software install, which of course, has no CA, CRL, etc. 

# some commands used 
cut -d\| -f1 z-ssc-hostIp-commonName-organizationName.txt | ./address-2-geoip-country-name.py | sort | uniq -c > z-ssc-count-by-cn.txt

sed 's/^\s*//'  z-ssc-count-by-cc.txt | sed 's/ /|/' > z-ssc-count-by-cc-piped.txt

grep '^23.' z-ssc-hostIp-commonName-organizationName.txt |less

cut -d\| -f2 z-ssc-hostIp-commonName-organizationName.txt | grep '.com$' > z-ssc-dot-com.txt

grep '^1|' z-org-name-counts-piped.txt > z-org-name-counts-piped-one-counts.txt

sed 's/ /|/' z-org-name-counts.txt > z-org-name-counts-piped.txt
